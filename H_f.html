<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>í•¨í‰ ìƒíƒœê°¯ë²Œ ìë£Œ â€” ì¹´ë“œ ìƒì„±/ìˆ˜ì •/ì‚­ì œ (ìë™ì €ì¥)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#fffef6; --card:#fff; --border:#d7dce3;
      --accent:#0a66c2; --danger:#dc2626; --muted:#6b7280;
      --radius:16px; --shadow:0 6px 20px rgba(0,0,0,0.06);
    }
    *{box-sizing:border-box}
    body{ margin:0; padding:24px; font-family:system-ui,-apple-system,"Noto Sans KR",Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:#222; line-height:1.6; }
    h1{ margin:0 0 6px; } p.lead{ margin:0 0 18px; color:var(--muted) }

    /* ì…ë ¥ í¼ */
    .form{ max-width:1100px; margin:0 auto 24px; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; display:grid; gap:12px; }
    .row{ display:grid; gap:12px; grid-template-columns: 1fr 2fr; }
    .field{ display:flex; flex-direction:column; gap:8px; } .field label{ font-weight:600 }
    input[type="file"]{ padding:10px; border:1px dashed #b8c1cc; border-radius:10px; background:#fafbff; }
    input[type="text"], input[type="url"], textarea{ border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:16px; width:100%; background:#fff; }
    textarea{ min-height:90px; resize:vertical }
    .actions{ display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap }
    .btn{ appearance:none; border:0; border-radius:999px; padding:10px 16px; font-weight:700; cursor:pointer; background:var(--accent); color:#fff; }
    .btn.secondary{ background:#475569 } .btn.danger{ background:var(--danger) }
    .hint{ font-size:13px; color:#667085 }

    /* ë¯¸ë¦¬ë³´ê¸° */
    .preview{ display:grid; grid-template-columns: 360px 1fr; gap:16px; align-items:stretch; background:#f9fafb; border:1px dashed #cbd5e1; border-radius:12px; padding:12px; }
    .preview .thumb{ background:#f3f4f6; border-radius:12px; aspect-ratio:3/2; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .preview img{ width:100%; height:100%; object-fit:cover; }
    .tags{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px } .tag{ font-size:12px; padding:4px 8px; border:1px solid #e5e7eb; border-radius:999px; background:#fff }

    /* ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ */
    .gallery{ max-width:1100px; margin:0 auto; display:grid; gap:18px; }
    .item{ display:grid; grid-template-columns: 360px 1fr; gap:24px; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; }
    .item .thumb{ border-radius:12px; overflow:hidden; background:#f3f3f3; aspect-ratio:3/2; display:flex; align-items:center; justify-content:center }
    .item img{ width:100%; height:100%; object-fit:cover }
    .item h3{ margin:4px 0 8px; font-size:22px; line-height:1.3 }
    .item h3 a{ color:#0a66c2; text-decoration:none } .item h3 a:hover{ text-decoration:underline }
    .item .item-actions{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .item .muted{ color:var(--muted); font-size:13px }

    /* í¸ì§‘ í¼(ì¹´ë“œ ë‚´ë¶€) */
    .edit-form{ display:grid; gap:10px; margin-top:8px; }
    .edit-form .grid{ display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
    .edit-form input[type="text"], .edit-form input[type="url"], .edit-form textarea, .edit-form input[type="file"]{ border:1px solid var(--border); border-radius:8px; padding:8px 10px; font-size:15px; width:100%; background:#fff; }
    .edit-form textarea{ min-height:80px }

    /* ë°˜ì‘í˜• */
    @media (max-width: 960px){
      .row{ grid-template-columns: 1fr }
      .preview{ grid-template-columns: 1fr }
      .item{ grid-template-columns: 1fr }
      .edit-form .grid{ grid-template-columns: 1fr }
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";
  
    const firebaseConfig = {
    apiKey: "AIzaSyDS4tth4jcq8CBgNiL2xylwZ49UncZrWCU",
    authDomain: "hampyeongman-5a5e3.firebaseapp.com",
    projectId: "hampyeongman-5a5e3",
    storageBucket: "hampyeongman-5a5e3.firebasestorage.app",
    messagingSenderId: "766021787942",
    appId: "1:766021787942:web:73b911069a7ebca47ee1e7",
    measurementId: "G-J58LPCVNKL"

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
  
    window._firebase = { db, storage, doc, getDoc, setDoc, storageRef, uploadString, getDownloadURL };
  </script>

};
  
</head>
<body>
  <h1>í•¨í‰ ìƒíƒœê°¯ë²Œ ìë£Œ â€” ì¹´ë“œ ìƒì„±/ìˆ˜ì •/ì‚­ì œ (ìë™ì €ì¥)</h1>
  <p class="lead">ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ ì‹œ ìë™ ì €ì¥ë©ë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•´ë„ ê·¸ëŒ€ë¡œ ë³µì›ë¼ìš”.</p>

  <!-- ì…ë ¥ í¼ -->
  <section class="form" aria-label="ìë£Œ ì…ë ¥ í¼">
    <div class="field">
      <label for="image">ì´ë¯¸ì§€ ì„ íƒ</label>
      <input id="image" type="file" accept="image/*">
      <span class="hint">* ì„œë²„ ì—…ë¡œë“œ ì—†ì´ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.</span>
    </div>

    <div class="row">
      <div class="field">
        <label for="title">ì œëª©</label>
        <input id="title" type="text" placeholder="ì˜ˆ) ì €ì–´ìƒˆ (Black-faced Spoonbill)">
      </div>
      <div class="field">
        <label for="link">ì œëª© ë§í¬ (ì˜µì…˜)</label>
        <input id="link" type="url" placeholder="ì˜ˆ) https://ko.wikipedia.org/wiki/ì €ì–´ìƒˆ">
      </div>
    </div>

    <div class="field">
      <label for="desc">ì„¤ëª…</label>
      <textarea id="desc" placeholder="ì˜ˆ) í•¨í‰ë§Œ ê°¯ë²Œì—ì„œ ê´€ì°°ë˜ëŠ” ëŒ€í‘œ ì² ìƒˆë¡œ, ì–•ì€ ê°¯ë²Œì—ì„œ ë¨¹ì´í™œë™ì„ í•©ë‹ˆë‹¤."></textarea>
    </div>

    <!-- ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° -->
    <div class="preview" aria-label="ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°">
      <div class="thumb" id="previewThumb">
        <span class="hint">ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</span>
      </div>
      <div class="content">
        <h2 id="previewTitle">ì œëª©(ë§í¬)</h2>
        <p class="hint" id="previewMeta">ë§í¬ë¥¼ ì…ë ¥í•˜ë©´ ì œëª©ì´ ë§í¬ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
        <p id="previewDesc">ì„¤ëª… ë¯¸ë¦¬ë³´ê¸°</p>
        <div class="tags">
          <span class="tag">ê°¯ë²Œ</span><span class="tag">í•¨í‰</span><span class="tag">ìƒíƒœ</span>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn secondary" id="resetBtn" type="button">ì´ˆê¸°í™”</button>
      <button class="btn" id="addBtn" type="button">ì¹´ë“œ ì¶”ê°€</button>
    </div>
  </section>

  <!-- ê°¤ëŸ¬ë¦¬ -->
  <section class="gallery" id="gallery" aria-label="ìë£Œ ì¹´ë“œ ëª©ë¡"></section>

  <script>
    const LS_KEY = 'hampyeong_gallery_v1';

    const imageInput = document.getElementById('image');
    const titleInput = document.getElementById('title');
    const linkInput  = document.getElementById('link');
    const descInput  = document.getElementById('desc');

    const previewThumb = document.getElementById('previewThumb');
    const previewTitle = document.getElementById('previewTitle');
    const previewMeta  = document.getElementById('previewMeta');
    const previewDesc  = document.getElementById('previewDesc');

    const addBtn   = document.getElementById('addBtn');
    const resetBtn = document.getElementById('resetBtn');
    const gallery  = document.getElementById('gallery');

    let currentImageURL = '';

    /* ----- ë¯¸ë¦¬ë³´ê¸° ----- */
    imageInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) { currentImageURL = ''; previewThumb.innerHTML = '<span class="hint">ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</span>'; return; }
      const reader = new FileReader();
      reader.onload = (evt) => {
        currentImageURL = evt.target.result; // dataURL ì €ì¥
        previewThumb.innerHTML = `<img src="${currentImageURL}" alt="ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€">`;
      };
      reader.readAsDataURL(file);
    });

    function updatePreview(){
      const title = titleInput.value.trim() || 'ì œëª©(ë§í¬)';
      const link  = linkInput.value.trim();
      previewTitle.innerHTML = link ? `<a href="${escapeAttr(link)}" target="_blank" rel="noopener">${escapeHtml(title)}</a>` : escapeHtml(title);
      previewMeta.textContent = link ? 'ì œëª©ì´ ë§í¬ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.' : 'ë§í¬ë¥¼ ì…ë ¥í•˜ë©´ ì œëª©ì´ ë§í¬ë¡œ í‘œì‹œë©ë‹ˆë‹¤.';
      previewDesc.textContent = descInput.value.trim() || 'ì„¤ëª… ë¯¸ë¦¬ë³´ê¸°';
    }
    titleInput.addEventListener('input', updatePreview);
    linkInput.addEventListener('input', updatePreview);
    descInput.addEventListener('input', updatePreview);
    updatePreview();

    /* ----- ì¹´ë“œ ë Œë”ë§ & ì§ë ¬í™” ----- */
    function cardToData(card){
      const img = card.querySelector('.thumb img');
      const h3  = card.querySelector('h3');
      const a   = h3 ? h3.querySelector('a') : null;
      const title = a ? a.textContent.trim() : (h3?.textContent.trim() || '');
      const link  = a ? a.getAttribute('href') : '';
      const desc  = card.querySelector('.desc')?.textContent || '';
      const imgSrc = img?.src || '';
      return { title, link, desc, imgSrc };
    }

    function serializeGallery(){
      const items = [...gallery.querySelectorAll('.item')];
      return items.map(cardToData);
    }

    function renderCard({title, link, desc, imgSrc}, prepend=true){
      const article = document.createElement('article');
      article.className = 'item';
      article.innerHTML = `
        <div class="thumb"><img src="${imgSrc}" alt="${escapeAttr(title)} ì´ë¯¸ì§€"></div>
        <div class="content">
          <h3>${link ? `<a href="${escapeAttr(link)}" target="_blank" rel="noopener">${escapeHtml(title)}</a>` : escapeHtml(title)}</h3>
          <p class="desc">${escapeHtml(desc || '')}</p>
          <div class="item-actions">
            <button class="btn secondary" data-action="edit">ìˆ˜ì •</button>
            <button class="btn danger" data-action="delete">ì‚­ì œ</button>
            <span class="muted">ì €ì¥ë¨</span>
          </div>
        </div>
      `;
      if (prepend) gallery.prepend(article); else gallery.append(article);
      return article;
    }

    function renderFromData(arr){
      gallery.innerHTML = '';
      arr.forEach(d => renderCard(d, false));
    }

    /* ----- ì €ì¥/ë³µì› ----- */
    function saveToStorage(){
      try{
        const data = serializeGallery();
        localStorage.setItem(LS_KEY, JSON.stringify(data));
      }catch(err){
        console.warn('ì €ì¥ ì‹¤íŒ¨(ìš©ëŸ‰ ì´ˆê³¼ ê°€ëŠ¥):', err);
        alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ ìš©ëŸ‰ì„ ì¤„ì´ê±°ë‚˜ ì¼ë¶€ ì¹´ë“œë¥¼ ì‚­ì œí•´ ì£¼ì„¸ìš”.');
      }
    }
    function loadFromStorage(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (Array.isArray(data)) renderFromData(data);
      }catch(err){
        console.warn('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err);
      }
    }
    function persistSoon(){
      clearTimeout(persistSoon._t);
      persistSoon._t = setTimeout(async () => {
        const data = serializeGallery();
        await saveToFirebase(data);
      }, 300);
    }

    /* ----- ì¶”ê°€/ì´ˆê¸°í™” ----- */
    addBtn.addEventListener('click', () => {
      const title = titleInput.value.trim();
      const link  = linkInput.value.trim();
      const desc  = descInput.value.trim();

      if (!currentImageURL){ alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
      if (!title){ alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

      renderCard({ title, link, desc, imgSrc: currentImageURL });
      resetForm();
      persistSoon();
    });

    function resetForm(){
      imageInput.value = ''; titleInput.value = ''; linkInput.value = ''; descInput.value = '';
      currentImageURL = '';
      previewThumb.innerHTML = '<span class="hint">ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</span>';
      updatePreview();
    }
    resetBtn.addEventListener('click', resetForm);

    /* ----- ê°¤ëŸ¬ë¦¬: ìˆ˜ì •/ì‚­ì œ ----- */
    gallery.addEventListener('click', (e) => {
      const btn = e.target.closest('button'); if (!btn) return;
      const card = e.target.closest('.item'); if (!card) return;
      const action = btn.dataset.action;

      if (action === 'delete'){
        if (confirm('ì´ ì¹´ë“œë¥¼ ì‚­ì œí• ê¹Œìš”?')){ card.remove(); persistSoon(); }
        return;
      }
      if (action === 'edit'){
        enterEditMode(card);
        return;
      }
      if (action === 'save'){ saveEdit(card); persistSoon(); return; }
      if (action === 'cancel'){ cancelEdit(card); return; }
    });

    function getCardSnapshot(card){ return cardToData(card); }

    function enterEditMode(card){
      if (card.dataset.editing === 'true') return;
      card.dataset.editing = 'true';
      card._backup = getCardSnapshot(card);

      const content = card.querySelector('.content');
      const { title, link, desc } = card._backup;

      content.innerHTML = `
        <div class="edit-form">
          <div class="grid">
            <input type="text" class="ef-title" placeholder="ì œëª©" value="${escapeHtml(title)}" />
            <input type="url" class="ef-link" placeholder="ì œëª© ë§í¬(ì˜µì…˜)" value="${escapeHtml(link)}" />
          </div>
          <textarea class="ef-desc" placeholder="ì„¤ëª…">${escapeHtml(desc)}</textarea>
          <div>
            <label class="hint">ì´ë¯¸ì§€ êµì²´(ì˜µì…˜)</label>
            <input type="file" class="ef-image" accept="image/*" />
          </div>
          <div class="item-actions">
            <button class="btn" data-action="save">ì €ì¥</button>
            <button class="btn secondary" data-action="cancel">ì·¨ì†Œ</button>
          </div>
        </div>
      `;

      const imgInput = content.querySelector('.ef-image');
      imgInput.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          const newSrc = evt.target.result;
          const imgEl = card.querySelector('.thumb img');
          imgEl.src = newSrc; // ë¯¸ë¦¬ë³´ê¸° ì¦‰ì‹œ ë°˜ì˜
        };
        reader.readAsDataURL(file);
      });
    }

    function saveEdit(card){
      const t = card.querySelector('.ef-title')?.value.trim() || '';
      const l = card.querySelector('.ef-link')?.value.trim() || '';
      const d = card.querySelector('.ef-desc')?.value.trim() || '';
      if (!t){ alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

      const imgSrc = card.querySelector('.thumb img')?.src || '';
      const content = card.querySelector('.content');
      content.innerHTML = `
        <h3>${l ? `<a href="${escapeAttr(l)}" target="_blank" rel="noopener">${escapeHtml(t)}</a>` : escapeHtml(t)}</h3>
        <p class="desc">${escapeHtml(d)}</p>
        <div class="item-actions">
          <button class="btn secondary" data-action="edit">ìˆ˜ì •</button>
          <button class="btn danger" data-action="delete">ì‚­ì œ</button>
          <span class="muted">ìˆ˜ì •ë¨</span>
        </div>
      `;
      card.dataset.editing = 'false';
    }

    function cancelEdit(card){
      const backup = card._backup || getCardSnapshot(card);
      const imgEl = card.querySelector('.thumb img');
      if (imgEl && backup.imgSrc) imgEl.src = backup.imgSrc; // ì´ë¯¸ì§€ ë³µì›
      const content = card.querySelector('.content');
      content.innerHTML = `
        <h3>${backup.link ? `<a href="${escapeAttr(backup.link)}" target="_blank" rel="noopener">${escapeHtml(backup.title)}</a>` : escapeHtml(backup.title)}</h3>
        <p class="desc">${escapeHtml(backup.desc)}</p>
        <div class="item-actions">
          <button class="btn secondary" data-action="edit">ìˆ˜ì •</button>
          <button class="btn danger" data-action="delete">ì‚­ì œ</button>
          <span class="muted">í¸ì§‘ ì·¨ì†Œ</span>
        </div>
      `;
      card.dataset.editing = 'false';
      delete card._backup;
    }

    /* ----- ìœ í‹¸ë¦¬í‹° ----- */
    function escapeHtml(str){ return (str || '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
    function escapeAttr(str){ return (str || '').replace(/"/g, '&quot;'); }

    /* ì‹œì‘: ì €ì¥ëœ ë°ì´í„° ë³µì› */
    loadFromFirebase().then(data => {
      if(Array.isArray(data)){
        renderFromData(data);
      }
    });

  </script>
  <script type="module">
  const { db, storage, doc, getDoc, setDoc, storageRef, uploadString, getDownloadURL } = window._firebase;

  /* ì¹´ë“œ ë°ì´í„°ë¥¼ Firestoreì— ì €ì¥ */
  async function saveToFirebase(data){
    await setDoc(
      doc(db, "hampyeong", "gallery"),   // ì›í•˜ëŠ” ê²½ë¡œë¡œ ë³€ê²½ ê°€ëŠ¥
      { cards: data }
    );
    console.log("ğŸ”¥ Firestore ì €ì¥ ì™„ë£Œ");
  }

  /* Firestoreì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° */
  async function loadFromFirebase(){
    const snap = await getDoc(doc(db, "hampyeong", "gallery"));
    if(snap.exists()) return snap.data().cards;
    return [];
  }
</script>

</body>
</html>
